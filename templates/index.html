{% extends "layout.html" %}
{% block content %}
<div class="p-4 bg-white rounded shadow-sm">
  <form method="post" class="mb-4" id="recommendationForm">
    <div class="input-group">
      <input type="text" name="query" class="form-control" placeholder="예: 탈모, 오메가3, 비타민D" required autocomplete="off" maxlength="50">
      <button class="btn btn-success" type="submit" id="submitBtn">
        <span class="submit-text">추천받기</span>
        <span class="loading-text d-none">
          <span class="spinner-border spinner-border-sm me-2" role="status"></span>
          분석중...
        </span>
      </button>
    </div>
    <small class="text-muted mt-2 d-block">💡 건강 관련 증상이나 영양소 이름을 입력해보세요</small>
  </form>

  <div class="loading" id="loadingIndicator">
    <div class="spinner"></div>
    <p class="mt-2 text-muted">AI가 맞춤 건강 정보를 분석하고 있습니다...</p>
  </div>

  {% if recommendation %}
    <div class="alert alert-info result-container" style="white-space: pre-wrap;">
      {{ recommendation }}
    </div>
  {% endif %}

  <!-- Optimized AdSense placeholder -->
  <div class="adsense-placeholder text-center mt-5" id="adsContainer">
    <p class="text-muted">📢 건강 관련 광고</p>
    <!-- AdSense will be injected here after page load -->
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('recommendationForm');
  const submitBtn = document.getElementById('submitBtn');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const submitText = submitBtn.querySelector('.submit-text');
  const loadingText = submitBtn.querySelector('.loading-text');
  
  // Form submission optimization
  form.addEventListener('submit', function(e) {
    const query = form.querySelector('input[name="query"]').value.trim();
    
    if (!query) {
      e.preventDefault();
      return;
    }
    
    // Show loading state
    submitBtn.disabled = true;
    submitText.classList.add('d-none');
    loadingText.classList.remove('d-none');
    loadingIndicator.style.display = 'block';
    
    // Store start time for performance tracking
    sessionStorage.setItem('requestStartTime', Date.now());
  });
  
  // Auto-focus on input for better UX
  const queryInput = form.querySelector('input[name="query"]');
  queryInput.focus();
  
  // Track performance if result is shown
  if (document.querySelector('.result-container')) {
    const startTime = sessionStorage.getItem('requestStartTime');
    if (startTime) {
      const duration = Date.now() - parseInt(startTime);
      console.log('AI recommendation generated in ' + duration + 'ms');
      sessionStorage.removeItem('requestStartTime');
    }
    
    // Scroll to result smoothly
    setTimeout(function() {
      const resultContainer = document.querySelector('.result-container');
      if (resultContainer) {
        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 100);
  }
  
  // Preload likely next interactions
  queryInput.addEventListener('input', function() {
    if (this.value.length > 2) {
      // Preconnect to API if user is typing
      const link = document.createElement('link');
      link.rel = 'preconnect';
      link.href = 'https://api.openai.com';
      document.head.appendChild(link);
    }
  });
});

// Service Worker registration for offline support (future enhancement)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    // This would register a service worker for offline functionality
    // Currently commented out as we don't have the SW file yet
    // navigator.serviceWorker.register('/sw.js');
  });
}
</script>

<style>
/* Additional optimized styles for this page */
.input-group {
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}

.form-control {
  border: none;
  padding: 12px 16px;
  font-size: 1rem;
  border-right: 1px solid #dee2e6;
}

.form-control:focus {
  box-shadow: none;
  border-color: #28a745;
}

.btn-success {
  border: none;
  padding: 12px 20px;
  font-weight: 600;
  min-width: 120px;
}

.result-container {
  animation: fadeIn 0.5s ease-in;
  border-left: 4px solid #17a2b8;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Mobile optimization */
@media (max-width: 768px) {
  .input-group {
    flex-direction: column;
  }
  
  .form-control {
    border-right: none;
    border-bottom: 1px solid #dee2e6;
    border-radius: 0;
  }
  
  .btn {
    border-radius: 0;
  }
}
</style>
{% endblock %}

